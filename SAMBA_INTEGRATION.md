# Samba Share Integration for Video Storage

This document explains how to set up and use the Samba share integration for storing and accessing videos generated by the AI Music Video Generator.

## Overview

The AI Music Video Generator now supports storing videos on a Samba share hosted on a Linode server. This provides several advantages:

1. **Centralized Storage**: All videos are stored in a central location, making them easier to manage.
2. **Network Access**: Videos can be accessed directly from Windows File Explorer using the network path.
3. **HTTP Access**: Videos can also be accessed via HTTP using Nginx (if configured).
4. **YouTube Integration**: The YouTube uploader agent can access videos directly from the share.

## Server Setup

The Samba share has been set up on a Linode server with the following configuration:

- **Server IP**: 172.236.12.109
- **Domain**: hyun.club
- **Share Name**: videos
- **Path**: /data/videos
- **User**: videouser

### Accessing the Share

From Windows:
1. Open File Explorer
2. In the address bar, type: `\\hyun.club\videos`
3. Enter credentials when prompted:
   - Username: videouser
   - Password: (the password you set)

From Linux:
```bash
# Mount the share
sudo mount -t cifs //hyun.club/videos /mnt/videos -o username=videouser,password=your_password
```

### HTTP Access

If Nginx is configured (using the provided `setup_nginx.sh` script), videos can also be accessed via HTTP:

```
http://hyun.club/videos/filename.mp4
```

## Configuration

The following environment variables are used for the Samba share integration:

```
VIDEO_SERVER=172.236.12.109
VIDEO_SERVER_USER=videouser
VIDEO_SERVER_PASSWORD=your_password
```

Add these to your `.env` file to configure the integration.

## Usage in Code

### UploaderAgent

The `UploaderAgent` has been updated to support the "local" upload provider, which uploads videos to the Samba share:

```python
# Initialize with local provider
uploader = UploaderAgent(upload_provider="local")

# Upload a video
result = uploader.upload_video(video_path, metadata={"title": "My Video"})
```

The `upload_video` method returns the HTTP URL for backward compatibility, but internally it stores both the network path and HTTP URL.

### Direct Access to Both URLs

If you need both the network path and HTTP URL, you can call the `_upload_to_local` method directly:

```python
result = uploader._upload_to_local(video_path, metadata={"title": "My Video"})
print(f"Network path: {result['network_path']}")
print(f"HTTP URL: {result['http_url']}")
```

### Database Schema

The database schema has been updated to store both URLs:

- `video_url`: The HTTP URL for the video (for web access)
- `network_path`: The network path for the video (for YouTube agent)

## Testing

A test script is provided to verify the Samba share integration:

```bash
python test_local_upload.py --video path/to/video.mp4 --title "Test Video"
```

This will upload the video to the Samba share and display both the network path and HTTP URL.

## Nginx Setup

To enable HTTP access to the videos, run the provided setup script on the server:

```bash
# Copy the script to the server
scp setup_nginx.sh root@172.236.12.109:~

# SSH to the server
ssh root@172.236.12.109

# Make the script executable
chmod +x setup_nginx.sh

# Run the script
./setup_nginx.sh
```

This will install and configure Nginx to serve videos from the Samba share.

## YouTube Agent Integration

The YouTube agent should be configured to access videos using the network path stored in the `network_path` field of the songs table. This allows the agent to directly access the videos without having to download them first.

Example code for the YouTube agent:

```python
# Query for songs with network_path but no youtube_id
songs = supabase.table("songs") \
    .select("*") \
    .is_("youtube_id", "null") \
    .not_.is_("network_path", "null") \
    .execute()

for song in songs.data:
    # Access the video using the network path
    video_path = song["network_path"]  # e.g., \\hyun.club\videos\song_123.mp4
    
    # Upload to YouTube
    youtube_id = youtube_client.upload_video(
        video_path=video_path,
        title=song["title"],
        description=song["description"],
        tags=song["style"].split(",") if song["style"] else []
    )
    
    # Update the database
    if youtube_id:
        supabase.table("songs").update({
            "youtube_id": youtube_id,
            "youtube_status": "uploaded"
        }).eq("id", song["id"]).execute()
```

## Troubleshooting

### Cannot Access the Share

If you cannot access the share, check the following:

1. **DNS Resolution**: Make sure hyun.club resolves to the correct IP address.
   ```bash
   nslookup hyun.club
   ```

2. **Firewall**: Make sure ports 139 and 445 are open on the server.
   ```bash
   ufw status
   ```

3. **Samba Service**: Make sure the Samba service is running.
   ```bash
   systemctl status smbd
   ```

4. **Credentials**: Make sure you're using the correct username and password.

### Cannot Access Videos via HTTP

If you cannot access videos via HTTP, check the following:

1. **Nginx Service**: Make sure Nginx is running.
   ```bash
   systemctl status nginx
   ```

2. **Nginx Configuration**: Check the Nginx configuration.
   ```bash
   nginx -t
   ```

3. **Firewall**: Make sure port 80 is open on the server.
   ```bash
   ufw status
   ```

4. **File Permissions**: Make sure Nginx can read the video files.
   ```bash
   ls -la /data/videos
   ```
