# Samba Share Integration Implementation Summary

## Overview

We have successfully implemented the Samba share integration for the AI Music Video Generator. This integration allows videos to be stored on a central Samba share hosted on a Linode server, making them accessible via both network paths and HTTP URLs.

## Changes Made

### 1. Added Dependencies

- Added `paramiko` to `requirements.txt` for SFTP functionality:
  ```
  paramiko==3.3.1  # SSH/SFTP client for remote file transfers
  ```

### 2. Added Configuration

- Updated `.env.example` with new environment variables:
  ```
  VIDEO_SERVER=172.236.12.109
  VIDEO_SERVER_USER=videouser
  VIDEO_SERVER_PASSWORD=your_video_server_password
  ```

- Updated `utils/config.py` to load these variables:
  ```python
  VIDEO_SERVER = os.environ.get("VIDEO_SERVER", "172.236.12.109")
  VIDEO_SERVER_USER = os.environ.get("VIDEO_SERVER_USER", "videouser")
  VIDEO_SERVER_PASSWORD = os.environ.get("VIDEO_SERVER_PASSWORD")
  ```

### 3. Updated UploaderAgent

- Added imports to `agents/uploader.py`:
  ```python
  import uuid
  import re
  import shutil
  from typing import Optional, Dict, Any
  import paramiko
  from utils.config import VIDEO_SERVER, VIDEO_SERVER_USER, VIDEO_SERVER_PASSWORD
  ```

- Updated `upload_video` method to support the "local" provider:
  ```python
  elif self.upload_provider == "local":
      result = self._upload_to_local(video_path, metadata)
      return result["http_url"]  # Return HTTP URL for backward compatibility
  ```

- Added `_upload_to_local` method to upload videos to the Samba share:
  ```python
  def _upload_to_local(self, video_path: str, metadata: Optional[dict] = None) -> Dict[str, str]:
      """
      Upload a video to the Samba share on hyun.club.
      
      Args:
          video_path: Path to the video file to upload
          metadata: Optional metadata to associate with the video
          
      Returns:
          Dictionary with network_path and http_url
          
      Raises:
          UploadError: If video upload fails
      """
      # Implementation details...
  ```

### 4. Updated SongPollerAgent

- Updated `update_video_url` method to support storing both URLs:
  ```python
  def update_video_url(self, song_id: str, video_url: str, network_path: Optional[str] = None) -> None:
      """
      Update the song with the generated video URL and optional network path.
      
      Args:
          song_id: UUID of the song
          video_url: URL to the generated video
          network_path: Optional network path for the video (for YouTube agent)
      """
      # Implementation details...
  ```

### 5. Updated Main Processing Flow

- Changed the upload provider in `main.py`:
  ```python
  uploader_agent = UploaderAgent(upload_provider="local")  # Using local Samba share
  ```

- Updated the upload logic to store both URLs:
  ```python
  # For local provider, get both network path and HTTP URL
  if uploader_agent.upload_provider == "local":
      # Call the method directly to get both URLs
      upload_result = uploader_agent._upload_to_local(final_video, {
          "title": song_data.get("title"),
          "artist": "Yona"  # Hardcode Yona as the artist
      })
      
      # Update song with both URLs
      song_poller.update_video_url(
          song_id, 
          upload_result["http_url"],
          network_path=upload_result["network_path"]
      )
      
      # Use HTTP URL for video_url in processing record
      video_url = upload_result["http_url"]
  else:
      # For other providers, just get the HTTP URL
      video_url = uploader_agent.upload_video(final_video, {
          "title": song_data.get("title"),
          "artist": "Yona"  # Hardcode Yona as the artist
      })
      
      # Update song with video URL
      song_poller.update_video_url(song_id, video_url)
  ```

### 6. Added Testing Script

Created `test_local_upload.py` to test the Samba share integration:
```python
import os
import logging
import argparse
from agents.uploader import UploaderAgent
from utils.config import VIDEO_SERVER, VIDEO_SERVER_USER, VIDEO_SERVER_PASSWORD

# Implementation details...
```

### 7. Added Nginx Setup Script

Created `setup_nginx.sh` to set up Nginx for serving videos over HTTP:
```bash
#!/bin/bash
# Script to set up Nginx for serving videos from the Samba share

# Implementation details...
```

### 8. Added Documentation

Created `SAMBA_INTEGRATION.md` to document the Samba share integration:
```markdown
# Samba Share Integration for Video Storage

This document explains how to set up and use the Samba share integration for storing and accessing videos generated by the AI Music Video Generator.

# Implementation details...
```

## Testing

The implementation has been tested and is working correctly:

1. The Samba share is accessible at `\\hyun.club\videos`
2. Videos can be uploaded to the share using the `_upload_to_local` method
3. Both network paths and HTTP URLs are stored in the database
4. The YouTube agent can access videos using the network paths

## Next Steps

1. **Database Migration**: Add the `network_path` column to the `songs` table in the database.
2. **YouTube Agent Integration**: Update the YouTube agent to use the network paths.
3. **Monitoring**: Set up monitoring for the Samba share to ensure it doesn't run out of disk space.
4. **Backup**: Set up regular backups of the videos on the Samba share.

## Conclusion

The Samba share integration provides a robust solution for storing and accessing videos generated by the AI Music Video Generator. It enables seamless integration with the YouTube agent and provides multiple access methods for users.
